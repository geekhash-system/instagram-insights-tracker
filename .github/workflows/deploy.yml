name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Create .clasprc.json
        run: |
          cat > ~/.clasprc.json << 'EOF'
          ${{ secrets.CLASPRC_JSON }}
          EOF
          echo "Created .clasprc.json"
          cat ~/.clasprc.json | jq . || echo "JSON validation failed"

      - name: Replace placeholders in config.gs
        run: |
          NERA_SPREADSHEET_ID="${{ secrets.NERA_SPREADSHEET_ID }}"
          KARAKO_SPREADSHEET_ID="${{ secrets.KARAKO_SPREADSHEET_ID }}"

          # Replace placeholders in config.gs
          sed -i "s/{{NERA_SPREADSHEET_ID}}/$NERA_SPREADSHEET_ID/" config.gs
          sed -i "s/{{KARAKO_SPREADSHEET_ID}}/$KARAKO_SPREADSHEET_ID/" config.gs
          echo "Updated config.gs with Spreadsheet IDs"
          grep "spreadsheetId" config.gs

      - name: Create .env.gs from secret
        run: |
          cat > .env.gs << 'EOF'
          ${{ secrets.ENV_GS }}
          EOF
          echo "Created .env.gs"

      - name: Deploy to NERA Apps Script
        run: |
          SCRIPT_ID="${{ secrets.SCRIPT_ID_NERA }}"
          sed -i "s/{{SCRIPT_ID}}/$SCRIPT_ID/" .clasp.json
          echo "Deploying to NERA (Script ID: $SCRIPT_ID)"
          clasp push
          echo "✅ NERA deployment complete"

      - name: Deploy to KARAKO Apps Script
        run: |
          SCRIPT_ID="${{ secrets.SCRIPT_ID_KARAKO }}"
          # Replace the NERA script ID with KARAKO script ID
          sed -i 's/"scriptId": "[^"]*"/"scriptId": "'$SCRIPT_ID'"/' .clasp.json
          echo "Deploying to KARAKO (Script ID: $SCRIPT_ID)"
          clasp push
          echo "✅ KARAKO deployment complete"
